(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     10906,        376]
NotebookOptionsPosition[      8879,        306]
NotebookOutlinePosition[      9753,        339]
CellTagsIndexPosition[      9710,        336]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Basic setup", "Section"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "@", 
   RowBox[{"NotebookDirectory", "[", "]"}]}], ";"}], "\n", 
 RowBox[{"Needs", "[", "\"\<Imports`\>\"", "]"}]}], "Code",
 CellChangeTimes->{
  3.670233912893641*^9, {3.670234238014649*^9, 3.670234249251326*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"neutralFaces", "=", 
   RowBox[{"images", "[", 
    RowBox[{"[", 
     RowBox[{"Range", "[", 
      RowBox[{"1", ",", 
       RowBox[{"Length", "@", "images"}], ",", "8"}], "]"}], "]"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{"Dimensions", "@", "neutralFaces"}], "\n", 
 RowBox[{"m", "=", 
  RowBox[{
   RowBox[{"Dimensions", "[", "neutralFaces", "]"}], "[", 
   RowBox[{"[", "1", "]"}], "]"}]}]}], "Code"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Step 1: Understand the dimensions along which faces differ", "Section"],

Cell["\<\
flattenedNeutralFaces is a matrix containing, as rows, each of the neutral \
face images.\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"flattenedNeutralFaces", "=", 
   RowBox[{"Transpose", "@", 
    RowBox[{"Flatten", "[", 
     RowBox[{"neutralFaces", ",", 
      RowBox[{"{", 
       RowBox[{"2", ",", "3"}], "}"}]}], "]"}]}]}], ";"}], "\n", 
 RowBox[{"Dimensions", "@", "flattenedNeutralFaces"}], "\n", 
 RowBox[{
  RowBox[{"normalizedFaces", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"#", "/", 
      RowBox[{"Mean", "[", "#", "]"}]}], "&"}], "/@", 
    "flattenedNeutralFaces"}]}], ";"}], "\n", 
 RowBox[{"Dimensions", "@", "normalizedFaces"}]}], "Code"],

Cell["Create the giant correlation matrix", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"corr1", "=", 
   RowBox[{"normalizedFaces", ".", 
    RowBox[{"Transpose", "[", "normalizedFaces", "]"}]}]}], ";"}], "\n", 
 RowBox[{"Dimensions", "@", "corr1"}]}], "Code"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"lambdas", ",", "vectors"}], "}"}], " ", "=", " ", 
   RowBox[{"Eigensystem", "[", "corr1", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"lambdas", "=", 
   RowBox[{"Sqrt", "/@", "lambdas"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"vectors", "=", 
   RowBox[{"Transpose", "@", "vectors"}]}], ";"}], "\n", 
 RowBox[{"Dimensions", "@", "lambdas"}], "\n", 
 RowBox[{"Dimensions", "@", "vectors"}]}], "Code",
 CellChangeTimes->{{3.670233984033493*^9, 3.670233998052384*^9}, 
   3.670234086022299*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"eigenfaces", "=", 
   RowBox[{
    RowBox[{"Transpose", "[", "normalizedFaces", "]"}], ".", "vectors"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"eigenfaces", "=", 
   RowBox[{"Transpose", "[", "eigenfaces", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"eigenfaces", "=", 
   RowBox[{"Map", "[", 
    RowBox[{"Normalize", ",", "eigenfaces"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Dimensions", "@", "eigenfaces"}]}], "Code"],

Cell[BoxData[{
 RowBox[{"Dimensions", "[", "vectors", "]"}], "\n", 
 RowBox[{
  RowBox[{"vectors", "[", 
   RowBox[{"[", "1", "]"}], "]"}], ".", 
  RowBox[{"vectors", "[", 
   RowBox[{"[", "2", "]"}], "]"}]}], "\n", 
 RowBox[{"Dimensions", "[", "eigenfaces", "]"}], "\n", 
 RowBox[{
  RowBox[{"eigenfaces", "[", 
   RowBox[{"[", "3", "]"}], "]"}], ".", 
  RowBox[{"eigenfaces", "[", 
   RowBox[{"[", "7", "]"}], "]"}]}]}], "Code",
 InitializationCell->False],

Cell["I wonder what the columns of v look like?", "Text"],

Cell[BoxData[
 RowBox[{"Grid", "@", 
  RowBox[{"Prepend", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"lambdas", "[", 
         RowBox[{"[", "i", "]"}], "]"}], ",", "\n", 
        RowBox[{"ImageAdjust", "@", 
         RowBox[{"Image", "@", 
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"eigenfaces", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", "256"}], "]"}]}]}]}], "}"}],
       ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "10"}], "}"}]}], "]"}], " ", ",", "\n", 
    RowBox[{"{", 
     RowBox[{
     "\"\<id\>\"", ",", "\"\<Singular Value\>\"", ",", "\"\<Vector\>\""}], 
     "}"}]}], "]"}]}]], "Code",
 InitializationCell->False,
 CellChangeTimes->{{3.670234540211706*^9, 3.670234544887525*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Use that decomposition to understand specific faces", "Section"],

Cell["Start decomposing the faces into eigencomponents", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"decompose", "[", 
   RowBox[{"face_", ",", "eigenfaces_", ",", "n_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\n", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{
      "face", " ", "is", " ", "a", " ", "1", "d", " ", "vector", " ", 
       "here"}], ",", " ", 
      RowBox[{
      "and", " ", "is", " ", "treated", " ", "implicitly", " ", "as", " ", 
       "a", " ", "row", " ", 
       RowBox[{"vector", "."}]}]}], " ", "*)"}], "\n", 
    RowBox[{
     RowBox[{"eigenfaces", "[", 
      RowBox[{"[", 
       RowBox[{"1", ";;", "n"}], "]"}], "]"}], ".", "face"}]}], "\n", 
   "]"}]}]], "Code"],

Cell["As a test, decompose my own face", "Text"],

Cell["Then build it back up.", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "@", "depth"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"depth", ":=", "30"}], ";"}]}], "Code",
 CellChangeTimes->{{3.670234585380802*^9, 3.670234602720825*^9}}],

Cell[BoxData[{
 RowBox[{"eigenme", "=", 
  RowBox[{"decompose", "[", 
   RowBox[{
    RowBox[{"Flatten", "@", "me"}], ",", "eigenfaces", ",", "depth"}], 
   "]"}]}], "\n", 
 RowBox[{"Image", "@", 
  RowBox[{"Partition", "[", 
   RowBox[{
    RowBox[{"Total", "[", 
     RowBox[{"MapThread", "[", 
      RowBox[{"Times", ",", 
       RowBox[{"{", 
        RowBox[{"eigenme", ",", 
         RowBox[{"eigenfaces", "[", 
          RowBox[{"[", 
           RowBox[{"1", ";;", "depth"}], "]"}], "]"}]}], "}"}]}], "]"}], 
     "]"}], ",", "256"}], "]"}]}]}], "Code",
 InitializationCell->False,
 CellChangeTimes->{3.670234585380802*^9}],

Cell["\<\
Notice that the reconstruction is lossy because I'm not in the training data\
\>", "Text"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Start recognizing faces", "Section"],

Cell[BoxData[
 RowBox[{
  RowBox[{"trainingFaces", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"decompose", "[", 
      RowBox[{"#", ",", "eigenfaces", ",", "depth"}], "]"}], "&"}], "/@", 
    "normalizedFaces"}]}], ";"}]], "Code"],

Cell[BoxData[
 RowBox[{
  RowBox[{"recognizeFace", "[", "face_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "i", "}"}], ",", "\n", 
    RowBox[{
     RowBox[{"i", "=", 
      RowBox[{
       RowBox[{"Nearest", "[", 
        RowBox[{
         RowBox[{"trainingFaces", "->", "Automatic"}], ",", 
         RowBox[{"decompose", "[", 
          RowBox[{
           RowBox[{"Flatten", "@", "face"}], ",", "eigenfaces", ",", 
           "depth"}], "]"}]}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\n", 
     RowBox[{"{", 
      RowBox[{"Image", "[", 
       RowBox[{"neutralFaces", "[", 
        RowBox[{"[", "i", "]"}], "]"}], "]"}], "}"}]}]}], "\n", 
   "]"}]}]], "Code"],

Cell[BoxData[
 RowBox[{"Nearest", "[", 
  RowBox[{
   RowBox[{"trainingFaces", "->", 
    RowBox[{"Image", "/@", "neutralFaces"}]}], ",", 
   RowBox[{"decompose", "[", 
    RowBox[{
     RowBox[{"Flatten", "@", "me"}], ",", "eigenfaces", ",", "depth"}], 
    "]"}]}], "]"}]], "Code"],

Cell[BoxData[{
 RowBox[{"Length", "@", 
  RowBox[{"trainingFaces", "[", 
   RowBox[{"[", "1", "]"}], "]"}]}], "\n", 
 RowBox[{"Length", "@", 
  RowBox[{"decompose", "[", 
   RowBox[{
    RowBox[{"Flatten", "@", "me"}], ",", "eigenfaces", ",", "depth"}], 
   "]"}]}]}], "Code"],

Cell[BoxData[
 RowBox[{"recognizeFace", "[", "me", "]"}]], "Code"],

Cell[BoxData[
 RowBox[{"Dimensions", "@", "neutralFaces"}]], "Code"],

Cell[BoxData[
 RowBox[{"Grid", "@", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Image", "[", "face", "]"}], ",", "\"\<\[Rule]\>\""}], "}"}], 
      ",", 
      RowBox[{"recognizeFace", "[", "face", "]"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"face", ",", 
      RowBox[{"images", "[", 
       RowBox[{"[", 
        RowBox[{"3", ";;", "100", ";;", "8"}], "]"}], "]"}]}], "}"}]}], 
   "]"}]}]], "Code"]
}, Open  ]]
},
EvaluatorNames->{"Local" -> {"AutoStartOnLaunch" -> True}},
NotebookAutoSave->True,
ClosingAutoSave->False,
ClosingSaveDialog->True,
CloseOnClickOutside->False,
IncludeFileExtension->True,
FileChangeProtection->Automatic,
AutoGeneratedPackage->Automatic,
Editable->True,
Saveable->True,
Evaluator->"Local",
EvaluationCompletionAction->{},
PrintAction->"PrintToNotebook",
OutputAutoOverwrite->True,
InitializationCellEvaluation->Automatic,
InitializationCellWarning->True,
NotebookEventActions->None,
NotebookDynamicExpression:>Null,
WindowSize->{960, 1028},
WindowMargins->{{-10, Automatic}, {Automatic, -10}},
FrontEndVersion->"10.3 for Linux x86 (64-bit) (December 10, 2015)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 30, 0, 65, "Section"],
Cell[613, 24, 267, 6, 71, "Code"],
Cell[883, 32, 438, 13, 90, "Code"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1358, 50, 77, 0, 65, "Section"],
Cell[1438, 52, 113, 3, 33, "Text"],
Cell[1554, 57, 562, 16, 109, "Code"],
Cell[2119, 75, 51, 0, 33, "Text"],
Cell[2173, 77, 208, 5, 71, "Code"],
Cell[2384, 84, 556, 15, 128, "Code"],
Cell[2943, 101, 452, 13, 109, "Code"],
Cell[3398, 116, 458, 13, 109, "Code",
 InitializationCell->False],
Cell[3859, 131, 57, 0, 33, "Text"],
Cell[3919, 133, 826, 24, 90, "Code",
 InitializationCell->False]
}, Open  ]],
Cell[CellGroupData[{
Cell[4782, 162, 70, 0, 65, "Section"],
Cell[4855, 164, 64, 0, 33, "Text"],
Cell[4922, 166, 680, 20, 110, "Code"],
Cell[5605, 188, 48, 0, 33, "Text"],
Cell[5656, 190, 38, 0, 33, "Text"],
Cell[5697, 192, 199, 5, 71, "Code"],
Cell[5899, 199, 629, 19, 71, "Code",
 InitializationCell->False],
Cell[6531, 220, 100, 2, 33, "Text"]
}, Open  ]],
Cell[CellGroupData[{
Cell[6668, 227, 42, 0, 65, "Section"],
Cell[6713, 229, 231, 7, 51, "Code"],
Cell[6947, 238, 712, 21, 110, "Code"],
Cell[7662, 261, 283, 8, 51, "Code"],
Cell[7948, 271, 276, 8, 71, "Code"],
Cell[8227, 281, 66, 1, 51, "Code"],
Cell[8296, 284, 68, 1, 51, "Code"],
Cell[8367, 287, 496, 16, 51, "Code"]
}, Open  ]]
}
]
*)

(* End of internal cache information *)

